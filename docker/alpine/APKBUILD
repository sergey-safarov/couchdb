# Maintainer: Sergey Safarov <s.safarov@gmail.com>
pkgname=couchdb
pkgver=2.1.0
pkgrel=0

# If building from a git snapshot, specify the gitcommit
# If building a proper release, leave gitcommit blank
#_gitcommit=180a1551435153779628a6698e41557b0e60339e

[ ! -z "${_gitcommit}" ] && pkgver="${pkgver}.$(date +%Y%m%d)"
[ ! -z "${_gitcommit}" ] && _suffix="-${_gitcommit:0:7}"
[ ! -z "${_gitcommit}" ] && builddir="$srcdir/$pkgname-$_gitcommit" || builddir="$srcdir/$pkgname-$pkgver"
[ -z "${_gitcommit}" ] && _gitcommit="${pkgver}"

pkgdesc="Open Source NoSQL database"
url="http://couchdb.apache.org/"
arch="all"
pkgusers="couchdb"
pkggroups="daemon"
arch="all"
license="GPL2+"
options="!fhs"
# depends="libressl2.5-libcrypto expat libgcc ncurses-libs libstdc++ zlib"
makedepends="nodejs-npm"
# makedepends="wget bash python2 gcc expat-dev libressl-dev erlang erlang-dev erlang-parsetools erlang-tools erlang-crypto erlang-syntax-tools erlang-ssl erlang-eunit erlang-hipe erlang-public-key erlang-asn1 erlang-inets erlang-xmerl erlang-observer erlang-sasl erlang-debugger erlang-runtime-tools"

source="${pkgname}-${pkgver}${_suffix}.tar.gz::https://github.com/apache/$pkgname/archive/$_gitcommit.tar.gz
"

snapshot() {
        if [ ! -f "$SRCDEST"/${pkgname}-${pkgver}${_suffix}.tar.gz ]; then
            wget -O "$SRCDEST"/${pkgname}-${pkgver}${_suffix}.tar.gz https://github.com/apache/$pkgname/archive/$_gitcommit.tar.gz
        fi
        SHA512SUM=$(sha512sum "$SRCDEST"/${pkgname}-${pkgver}${_suffix}.tar.gz | sed -e "s:$SRCDEST/::")
        sed -i -e "s/^\(sha512sums=.\).*/\1$SHA512SUM/" APKBUILD
}

prepare() {
	default_prepare
	cd "$builddir"
}

build() {
	cd "$builddir"
	export COUCHDB_VERSION=${pkgver}
	./configure --disable-docs
	./bin/rebar get-deps
	./bin/rebar compile
	make
	return 1
}

package() {
	cd "$builddir"
	mkdir -p $pkgdir/opt
	cp -R _rel/kazoo $pkgdir/opt
	cp sup.bash $pkgdir/opt/kazoo
	mkdir $pkgdir/opt/kazoo/logs
}

sha512sums="8dc6b716ae834b2984f71b22b51e34135d356722196b9faae932670a906b040527ad71f4d36e4bd8de392178fc4e2582ddf827fdd5c02d1c5f13528f750fcd0c  couchdb-2.1.0.tar.gz
"
